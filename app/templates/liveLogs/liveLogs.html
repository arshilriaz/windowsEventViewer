<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Logs</title>
    <link rel="stylesheet" href="/templates/liveLogs/liveLogs.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.1.0/css/adminlte.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.1.0/js/adminlte.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3"></script>
</head>

<body class="hold-transition sidebar-mini layout-fixed">
    <div class="wrapper">
        <!-- Navbar -->
        <nav class="main-header navbar navbar-expand navbar-white navbar-light">
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link" data-widget="pushmenu" href="javascript:void(0);" role="button"><i
                            class="fas fa-bars"></i></a>
                </li>
                <li class="nav-item d-none d-sm-inline-block">
                    <a href="#" class="nav-link">Home</a>
                </li>
                <li class="nav-item d-none d-sm-inline-block">
                    <a href="#" class="nav-link">Contact</a>
                </li>
            </ul>
        </nav>
        <!-- /.navbar -->

        <!-- Sidebar -->
        <aside class="main-sidebar sidebar-dark-primary elevation-4">
            <!-- Brand Logo -->
            <a href="#" class="brand-link">
                <span class="brand-text font-weight-light">Live Logs</span>
            </a>

            <!-- Sidebar Menu -->
            <div class="sidebar">
                <nav class="mt-2">
                    <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu"
                        data-accordion="false">
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="nav-icon fas fa-plug"></i>
                                <p>Connect to a machine</p>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#" class="nav-link">
                                <i class="nav-icon fas fa-check-circle"></i>
                                <p>Verify credentials</p>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
            <!-- /.sidebar -->
        </aside>

        <!-- Content Wrapper. Contains page content -->
        <div class="content-wrapper">
            <!-- Content Header (Page header) -->
            <div class="content-header">
                <div class="container-fluid">
                    <div class="row mb-2">
                        <div class="col-sm-6">
                            <h1 class="m-0">Live Logs</h1>
                        </div>
                        <div class="col-sm-6">
                            <ol class="breadcrumb float-sm-right">
                                <li class="breadcrumb-item"><a href="#">Home</a></li>
                                <li class="breadcrumb-item active">Live Logs</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>
            <!-- /.content-header -->

            <!-- Main content -->
            <section class="content">
                <div class="container-fluid">
                    <!-- Display the Status Summary in Cards -->
                    <div class="row" id="log-cards">
                        <!-- Cards will be dynamically added here -->
                    </div>

                    <div class="row mt-4">
                        <div class="col-md-12">
                            <div class="card-header">
                                <h3 class="card-title">Log Details</h3>
                                <div class="form-group float-right">
                                    <label for="timeFilter" class="mr-2">Filter by Time:</label>
                                    <select id="timeFilter" class="form-control form-control-sm">
                                        <option value="all">All Time</option>
                                        <option value="last24hours">Last 24 Hours</option>
                                        <option value="last7days">Last 7 Days</option>
                                        <option value="last30days">Last 30 Days</option>
                                    </select>
                                </div>
                            </div>
                            <div id="log-details" class="card" style="max-height: 400px; overflow-y: auto;">
                                <div class="card-body">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Level</th>
                                                <th>Event ID</th>
                                                <th>Time Created</th>
                                                <th>Provider Name</th>
                                            </tr>
                                        </thead>
                                        <tbody id="log-details-body" class="log-row">
                                            <!-- Log details will be inserted here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Display Pie Chart in a Card -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Event Log Distribution</h3>
                        </div>
                        <div class="card-body">
                            <div class="row justify-content-center">
                                <div class="col-md-12">
                                    <canvas id="logPieChart" style="width: 200px; height: 200px;"></canvas>
                                </div>
                            </div>
                            <div class="row mt-4">
                                <div class="col-md-12 text-center">
                                    <p>Overview of the log event distribution for different severity levels.</p>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <a href="#" class="text-primary">View Detailed Report</a>
                            <span class="float-right">
                                <a href="#" class="text-secondary">Download Data</a>
                            </span>
                        </div>
                    </div>

            </section>
        </div>
    </div>

    <!-- Hidden Form Data for API Request -->
    <div id="formData" data-hostname="{{ form_data['hostname'] }}" data-username="{{ form_data['username'] }}"
        data-password="{{ form_data['password'] }}" style="display:none;"></div>

    <!-- Modal for Log Details -->
    <!-- Modal for Log Details -->
    <div class="modal fade" id="logDetailModal" tabindex="-1" aria-labelledby="logDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="logDetailModalLabel">Log Details</h5>
                </div>
                <div class="modal-body">
                    <!-- Log details will be dynamically added here -->
                    <div id="modal-log-details"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3"></script>

    <script>
        // Retrieve data attributes for hostname, username, and password
        const formData = document.getElementById('formData');
        const hostname = formData.getAttribute('data-hostname');
        const username = formData.getAttribute('data-username');
        const password = formData.getAttribute('data-password');

        // Define a consistent color mapping for log levels
        const cardColors = {
            'Critical': { bgColor: 'bg-danger', color: 'rgba(255, 99, 132, 0.6)', borderColor: 'rgba(255, 99, 132, 1)' },
            'Warning': { bgColor: 'bg-warning', color: 'rgba(255, 206, 86, 0.6)', borderColor: 'rgba(255, 206, 86, 1)' },
            'Error': { bgColor: 'bg-danger', color: 'rgba(255, 69, 0, 0.6)', borderColor: 'rgba(255, 69, 0, 1)' }, // Explicit danger color
            'Information': { bgColor: 'bg-info', color: 'rgba(54, 162, 235, 0.6)', borderColor: 'rgba(54, 162, 235, 1)' },
            'Default': { bgColor: 'bg-secondary', color: 'rgba(153, 102, 255, 0.6)', borderColor: 'rgba(153, 102, 255, 1)' }
        };

        const cardIcons = {
            'Critical': { icon: 'fas fa-times-circle' },
            'Warning': { icon: 'fas fa-exclamation-triangle' },
            'Error': { icon: 'fas fa-times-circle' }, // Explicit danger color
            'Information': { icon: 'fas fa-info-circle' },
            'Default': { icon: 'fas fa-info-circle' }
        };

        // Initialize EventSource for live logs
        var eventSource = new EventSource('/liveLogs?hostname=' + hostname + '&username=' + username + '&password=' + password);

        // Event listener to handle incoming log data
        eventSource.onmessage = function (event) {
            var data = JSON.parse(event.data);

            // Generate cards and update Pie chart based on levelDisplayCounts
            updatePieChart(data.levelDisplayCounts);
            logsData = data.levelDisplayCounts; // Store the logs data for later use
            generateLogCards(data.levelDisplayCounts, data.newLogs);
        };

        var storedLogs = {};

        function generateLogCards(levelDisplayCounts, newLogs) {
            storedLogs = newLogs; // Update the global variable

            const logCardsContainer = document.getElementById('log-cards');
            logCardsContainer.innerHTML = ''; // Clear existing cards

            for (const [level, count] of Object.entries(levelDisplayCounts)) {
                const cardColor = cardColors[level] ? cardColors[level].bgColor : cardColors['Default'].bgColor;
                const icon = cardIcons[level] ? cardIcons[level].icon : cardIcons['Default'].icon;

                const cardHtml = `
                    <div class="col-lg-3 col-6">
                        <div class="small-box ${cardColor}" data-log-level="${level}">
                            <div class="inner">
                                <h3>${count}</h3>
                                <p>${level}</p>
                            </div>
                            <div class="icon">
                                <i class="${icon}"></i>
                            </div>
                        </div>
                    </div>
                `;
                logCardsContainer.insertAdjacentHTML('beforeend', cardHtml);
            }

            // Add click event listeners to each card
            const cards = logCardsContainer.querySelectorAll('.small-box');
            cards.forEach(card => {
                card.addEventListener('click', function () {
                    storedLogs = newLogs;
                    const logLevel = this.getAttribute('data-log-level');
                    displayLogsForLevel(logLevel);
                });
            });
        }

        document.getElementById('timeFilter').addEventListener('change', function () {
            const activeCard = document.querySelector('.small-box.active');
            if (activeCard) {
                const logLevel = activeCard.getAttribute('data-log-level');
                displayLogsForLevel(logLevel);
            } else {
                displayAllLogs(); // Function to display all logs filtered by time
            }
        });

        function displayLogsForLevel(level) {
            const logDetails = document.getElementById('log-details');
            const logDetailsBody = document.getElementById('log-details-body');
            const timeFilter = document.getElementById('timeFilter').value;

            // Clear previous logs
            logDetailsBody.innerHTML = '';

            // Filter logs based on the selected level
            let filteredLogs = storedLogs.filter(log => log.LevelDisplayName === level);
            storedLogs = filteredLogs

            // Get the current time
            const now = new Date();

            // Further filter the logs based on the selected time filter
            if (timeFilter === 'last24hours') {
                const last24Hours = now - (24 * 60 * 60 * 1000);
                filteredLogs = filteredLogs.filter(log => parseInt(log.TimeCreated.match(/\d+/)[0]) >= last24Hours);
            } else if (timeFilter === 'last7days') {
                const last7Days = now - (7 * 24 * 60 * 60 * 1000);
                filteredLogs = filteredLogs.filter(log => parseInt(log.TimeCreated.match(/\d+/)[0]) >= last7Days);
            } else if (timeFilter === 'last30days') {
                const last30Days = now - (30 * 24 * 60 * 60 * 1000);
                filteredLogs = filteredLogs.filter(log => parseInt(log.TimeCreated.match(/\d+/)[0]) >= last30Days);
            }

            // Populate the table with logs filtered by both log level and time
            filteredLogs.forEach(log => {
                const timestamp = parseInt(log.TimeCreated.match(/\d+/)[0]);
                const row = `
                <tr class="log-row" data-toggle="modal" data-target="#logDetailModal" data-log-id="${log.Id}">
                    <td>${log.LevelDisplayName}</td>
                    <td>${log.Id}</td>
                    <td>${new Date(timestamp).toString()}</td>
                    <td>${log.ProviderName}</td>
                </tr>
            `;
                logDetailsBody.insertAdjacentHTML('beforeend', row);
            });

            // Show the log details section
            logDetails.style.display = 'block';

            // Add event listener to rows to trigger modal with log details
            const logRows = document.querySelectorAll('.log-row');
            logRows.forEach(row => {
                row.addEventListener('click', function () {
                    const logId = this.getAttribute('data-log-id');
                    displayLogDetailsModal(logId);
                });
            });
        }
        function displayAllLogs() {
            const logDetails = document.getElementById('log-details');
            const logDetailsBody = document.getElementById('log-details-body');
            const timeFilter = document.getElementById('timeFilter').value;

            // Clear previous logs
            logDetailsBody.innerHTML = '';

            let filteredLogs = storedLogs; // Start with all logs

            // Get the current time
            const now = new Date();

            // Apply the time filter to all logs
            if (timeFilter === 'last24hours') {
                const last24Hours = now - (24 * 60 * 60 * 1000);
                filteredLogs = filteredLogs.filter(log => parseInt(log.TimeCreated.match(/\d+/)[0]) >= last24Hours);
            } else if (timeFilter === 'last7days') {
                const last7Days = now - (7 * 24 * 60 * 60 * 1000);
                filteredLogs = filteredLogs.filter(log => parseInt(log.TimeCreated.match(/\d+/)[0]) >= last7Days);
            } else if (timeFilter === 'last30days') {
                const last30Days = now - (30 * 24 * 60 * 60 * 1000);
                filteredLogs = filteredLogs.filter(log => parseInt(log.TimeCreated.match(/\d+/)[0]) >= last30Days);
            }

            // Populate the table with logs
            filteredLogs.forEach(log => {
                const timestamp = parseInt(log.TimeCreated.match(/\d+/)[0]);
                const row = `
                <tr class="log-row" data-toggle="modal" data-target="#logDetailModal" data-log-id="${log.Id}">
                    <td>${log.LevelDisplayName}</td>
                    <td>${log.Id}</td>
                    <td>${new Date(timestamp).toString()}</td>
                    <td>${log.ProviderName}</td>
                </tr>
            `;
                logDetailsBody.insertAdjacentHTML('beforeend', row);
            });

            // Show the log details section
            logDetails.style.display = 'block';

            // Add event listener to rows to trigger modal with log details
            const logRows = document.querySelectorAll('.log-row');
            logRows.forEach(row => {
                row.addEventListener('click', function () {
                    const logId = this.getAttribute('data-log-id');
                    displayLogDetailsModal(logId);
                });
            });
        }
        // Function to display log details in modal
        function displayLogDetailsModal(logId) {
            // Find the log with the matching ID from storedLogs
            const log = storedLogs.find(log => log.Id == logId);

            // Populate the modal with log details
            const modalLogDetails = document.getElementById('modal-log-details');
            modalLogDetails.innerHTML = `
            <p><strong>Level:</strong> ${log.LevelDisplayName}</p>
            <p><strong>Event ID:</strong> ${log.Id}</p>
            <p><strong>Time Created:</strong> ${new Date(parseInt(log.TimeCreated.match(/\d+/)[0])).toString()}</p>
            <p><strong>Provider Name:</strong> ${log.ProviderName}</p>
            <p><strong>Message:</strong> ${log.Message}</p>
        `;
        }

        // Function to update Pie Chart
        function updatePieChart(levelDisplayCounts) {
            const labels = Object.keys(levelDisplayCounts);
            const data = Object.values(levelDisplayCounts);
            const backgroundColors = labels.map(label => cardColors[label] ? cardColors[label].color : cardColors['Default'].color);
            const borderColors = labels.map(label => cardColors[label] ? cardColors[label].borderColor : cardColors['Default'].borderColor);

            logPieChart.data.labels = labels;
            logPieChart.data.datasets[0].data = data;
            logPieChart.data.datasets[0].backgroundColor = backgroundColors;
            logPieChart.data.datasets[0].borderColor = borderColors;
            logPieChart.update();
        }

        const ctx = document.getElementById('logPieChart').getContext('2d');
        const logPieChart = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    backgroundColor: [],
                    borderColor: [],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function (tooltipItem) {
                                let label = tooltipItem.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                label += tooltipItem.raw;
                                return label + ' logs';
                            }
                        }
                    }
                }
            }
        });

    </script>

</body>

</html>